<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MewTrack è°ƒè¯•å·¥å…·</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .header h1 {
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .section h2 {
      margin-top: 0;
      color: #444;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 10px;
    }
    
    .status-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .status-item:last-child {
      border-bottom: none;
    }
    
    .status-label {
      font-weight: 500;
      color: #555;
    }
    
    .status-value {
      font-family: monospace;
      font-size: 14px;
    }
    
    .status-ok {
      color: #28a745;
    }
    
    .status-error {
      color: #dc3545;
    }
    
    .status-warning {
      color: #ffc107;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5a6fd8;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    .log-container {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 10px;
      margin-top: 15px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
    
    .test-links {
      margin-top: 15px;
    }
    
    .test-link {
      display: inline-block;
      margin: 5px 10px 5px 0;
      color: #667eea;
      text-decoration: none;
      font-size: 14px;
    }
    
    .test-link:hover {
      text-decoration: underline;
    }
    
    .info-box {
      background: #e8f4fd;
      border: 1px solid #b8daff;
      border-radius: 4px;
      padding: 15px;
      margin-top: 15px;
    }
    
    .info-box h3 {
      margin-top: 0;
      color: #004085;
    }
    
    .info-box p {
      margin: 5px 0;
      color: #004085;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ± MewTrack è°ƒè¯•å·¥å…·</h1>
    <p>æ£€æŸ¥æ’ä»¶çŠ¶æ€å’Œæµ‹è¯•åŠŸèƒ½</p>
  </div>

  <div class="section">
    <h2>æ’ä»¶çŠ¶æ€</h2>
    <div class="status-item">
      <span class="status-label">æ’ä»¶ç‰ˆæœ¬:</span>
      <span class="status-value" id="version">æ£€æµ‹ä¸­...</span>
    </div>
    <div class="status-item">
      <span class="status-label">å­˜å‚¨çŠ¶æ€:</span>
      <span class="status-value" id="storage-status">æ£€æµ‹ä¸­...</span>
    </div>
    <div class="status-item">
      <span class="status-label">OpenAI API:</span>
      <span class="status-value" id="api-status">æ£€æµ‹ä¸­...</span>
    </div>
    <div class="status-item">
      <span class="status-label">ä»Šæ—¥æ‰“å¡ç½‘ç«™æ•°:</span>
      <span class="status-value" id="today-sites">æ£€æµ‹ä¸­...</span>
    </div>
    <div class="status-item">
      <span class="status-label">æ€»è¿ç»­å¤©æ•°:</span>
      <span class="status-value" id="total-streak">æ£€æµ‹ä¸­...</span>
    </div>
  </div>

  <div class="section">
    <h2>è§†é¢‘ç½‘ç«™æµ‹è¯•</h2>
    <p>ç‚¹å‡»ä»¥ä¸‹é“¾æ¥æµ‹è¯•è§†é¢‘æ£€æµ‹åŠŸèƒ½ï¼ˆåœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ï¼‰:</p>
    
    <div class="test-links">
      <strong>YouTube æµ‹è¯•:</strong><br>
      <a href="https://www.youtube.com/watch?v=RRKJiM9Njr8" target="_blank" class="test-link">
        ğŸ“š å­¦ä¹ ç±»: My Mix for Work & Study
      </a>
      <a href="https://www.youtube.com/watch?v=jfKfPfyJRdk" target="_blank" class="test-link">
        ğŸ“š å­¦ä¹ ç±»: lofi hip hop radio
      </a>
      <a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ" target="_blank" class="test-link">
        ğŸµ å¨±ä¹ç±»: éŸ³ä¹MV
      </a>
    </div>
    
    <div class="test-links">
      <strong>Bilibili æµ‹è¯•:</strong><br>
      <a href="https://www.bilibili.com/video/BV1GJ411x7h7" target="_blank" class="test-link">
        ğŸ“š å­¦ä¹ ç±»: Pythonæ•™ç¨‹
      </a>
      <a href="https://www.bilibili.com/video/BV1FX4y1g7u8" target="_blank" class="test-link">
        ğŸ® å¨±ä¹ç±»: æ¸¸æˆè§†é¢‘
      </a>
    </div>
    
    <div class="info-box">
      <h3>æµ‹è¯•è¯´æ˜</h3>
      <p>1. ç‚¹å‡»é“¾æ¥åï¼Œç­‰å¾…3-5ç§’è®©é¡µé¢å®Œå…¨åŠ è½½</p>
      <p>2. å¦‚æœæ˜¯å­¦ä¹ ç±»è§†é¢‘ï¼Œåº”è¯¥ä¼šå¼¹å‡ºæ‰“å¡çª—å£</p>
      <p>3. å¦‚æœæ˜¯å¨±ä¹ç±»è§†é¢‘ï¼Œä¸ä¼šæœ‰å¼¹çª—</p>
      <p>4. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°(F12)å¯ä»¥çœ‹åˆ°è¯¦ç»†çš„æ£€æµ‹æ—¥å¿—</p>
    </div>
  </div>

  <div class="section">
    <h2>åŠŸèƒ½æµ‹è¯•</h2>
    <div class="button-group">
      <button class="btn-primary" onclick="testStorage()">æµ‹è¯•å­˜å‚¨</button>
      <button class="btn-primary" onclick="testSiteDetection()">æµ‹è¯•ç½‘ç«™æ£€æµ‹</button>
      <button class="btn-primary" onclick="clearTodayData()">æ¸…é™¤ä»Šæ—¥æ•°æ®</button>
      <button class="btn-secondary" onclick="openSettings()">æ‰“å¼€è®¾ç½®</button>
      <button class="btn-secondary" onclick="openPopup()">æ‰“å¼€å¼¹çª—</button>
    </div>
    
    <div class="log-container" id="log"></div>
  </div>

  <div class="section">
    <h2>è‡ªå®šä¹‰ç½‘ç«™</h2>
    <div id="custom-sites-list">
      åŠ è½½ä¸­...
    </div>
  </div>

  <script src="js/storage.js"></script>
  <script src="js/openaiIntegration.js"></script>
  <script src="js/siteDetector.js"></script>
  
  <script>
    const logContainer = document.getElementById('log');
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
      logContainer.textContent += `[${timestamp}] ${prefix} ${message}\n`;
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    // åˆå§‹åŒ–
    async function init() {
      try {
        // è·å–manifestä¿¡æ¯
        const manifest = chrome.runtime.getManifest();
        document.getElementById('version').textContent = manifest.version;
        document.getElementById('version').className = 'status-value status-ok';
        
        // æ£€æŸ¥å­˜å‚¨
        const storage = new MewTrackStorage();
        const data = await storage.getAllData();
        document.getElementById('storage-status').textContent = 'æ­£å¸¸';
        document.getElementById('storage-status').className = 'status-value status-ok';
        
        // æ£€æŸ¥APIçŠ¶æ€
        await openAIIntegration.init();
        const apiStatus = document.getElementById('api-status');
        if (openAIIntegration.apiKey) {
          apiStatus.textContent = 'å·²é…ç½®';
          apiStatus.className = 'status-value status-ok';
        } else {
          apiStatus.textContent = 'æœªé…ç½®';
          apiStatus.className = 'status-value status-warning';
        }
        
        // æ˜¾ç¤ºç»Ÿè®¡
        const stats = await storage.getStats();
        document.getElementById('today-sites').textContent = stats.checkedSitesToday || 0;
        document.getElementById('total-streak').textContent = stats.totalStreak || 0;
        
        // åŠ è½½è‡ªå®šä¹‰ç½‘ç«™
        await loadCustomSites();
        
        log('è°ƒè¯•å·¥å…·åˆå§‹åŒ–å®Œæˆ', 'success');
      } catch (error) {
        log('åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
      }
    }

    // åŠ è½½è‡ªå®šä¹‰ç½‘ç«™
    async function loadCustomSites() {
      try {
        const storage = new MewTrackStorage();
        const customSites = await storage.getCustomSites();
        const container = document.getElementById('custom-sites-list');
        
        if (Object.keys(customSites).length === 0) {
          container.innerHTML = '<p>æ²¡æœ‰è‡ªå®šä¹‰ç½‘ç«™</p>';
        } else {
          const html = Object.entries(customSites).map(([domain, site]) => `
            <div class="status-item">
              <span class="status-label">${site.name}</span>
              <span class="status-value ${site.enabled ? 'status-ok' : 'status-error'}">
                ${domain} (${site.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'})
              </span>
            </div>
          `).join('');
          container.innerHTML = html;
        }
      } catch (error) {
        document.getElementById('custom-sites-list').innerHTML = '<p class="status-error">åŠ è½½å¤±è´¥</p>';
      }
    }

    // æµ‹è¯•å­˜å‚¨
    async function testStorage() {
      log('å¼€å§‹æµ‹è¯•å­˜å‚¨åŠŸèƒ½...');
      try {
        const storage = new MewTrackStorage();
        const data = await storage.getAllData();
        log('æˆåŠŸè¯»å–æ•°æ®ï¼Œç½‘ç«™æ•°: ' + Object.keys(data.sites || {}).length, 'success');
        
        // æµ‹è¯•å†™å…¥
        const testData = { test: Date.now() };
        await chrome.storage.local.set({ mewtrack_test: testData });
        const readData = await chrome.storage.local.get('mewtrack_test');
        
        if (readData.mewtrack_test.test === testData.test) {
          log('å­˜å‚¨è¯»å†™æµ‹è¯•æˆåŠŸ', 'success');
        } else {
          log('å­˜å‚¨è¯»å†™æµ‹è¯•å¤±è´¥', 'error');
        }
        
        // æ¸…ç†æµ‹è¯•æ•°æ®
        await chrome.storage.local.remove('mewtrack_test');
      } catch (error) {
        log('å­˜å‚¨æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
      }
    }

    // æµ‹è¯•ç½‘ç«™æ£€æµ‹
    async function testSiteDetection() {
      log('å¼€å§‹æµ‹è¯•ç½‘ç«™æ£€æµ‹...');
      try {
        const currentDomain = window.location.hostname;
        const isLearning = await siteDetector.isLearningSite(currentDomain);
        log(`å½“å‰åŸŸå: ${currentDomain}`, 'info');
        log(`æ˜¯å¦ä¸ºå­¦ä¹ ç½‘ç«™: ${isLearning}`, isLearning ? 'success' : 'info');
        
        const siteInfo = await siteDetector.getSiteInfo(currentDomain);
        if (siteInfo) {
          log(`ç½‘ç«™ä¿¡æ¯: ${siteInfo.name} (${siteInfo.type})`, 'info');
        }
      } catch (error) {
        log('ç½‘ç«™æ£€æµ‹å¤±è´¥: ' + error.message, 'error');
      }
    }

    // æ¸…é™¤ä»Šæ—¥æ•°æ®
    async function clearTodayData() {
      if (confirm('ç¡®å®šè¦æ¸…é™¤ä»Šæ—¥æ‰“å¡æ•°æ®å—ï¼Ÿ')) {
        try {
          const storage = new MewTrackStorage();
          const data = await storage.getAllData();
          data.globalStats.checkedSitesToday = [];
          await storage.saveAllData(data);
          log('ä»Šæ—¥æ•°æ®å·²æ¸…é™¤', 'success');
          await init(); // åˆ·æ–°æ˜¾ç¤º
        } catch (error) {
          log('æ¸…é™¤å¤±è´¥: ' + error.message, 'error');
        }
      }
    }

    // æ‰“å¼€è®¾ç½®
    function openSettings() {
      chrome.runtime.openOptionsPage();
    }

    // æ‰“å¼€å¼¹çª—
    function openPopup() {
      window.open(chrome.runtime.getURL('popup.html'), 'MewTrack', 'width=400,height=600');
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    init();
  </script>
</body>
</html>