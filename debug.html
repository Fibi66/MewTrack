<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MewTrack 调试工具</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .header h1 {
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .section h2 {
      margin-top: 0;
      color: #444;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 10px;
    }
    
    .status-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .status-item:last-child {
      border-bottom: none;
    }
    
    .status-label {
      font-weight: 500;
      color: #555;
    }
    
    .status-value {
      font-family: monospace;
      font-size: 14px;
    }
    
    .status-ok {
      color: #28a745;
    }
    
    .status-error {
      color: #dc3545;
    }
    
    .status-warning {
      color: #ffc107;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5a6fd8;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    .log-container {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 10px;
      margin-top: 15px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
    
    .test-links {
      margin-top: 15px;
    }
    
    .test-link {
      display: inline-block;
      margin: 5px 10px 5px 0;
      color: #667eea;
      text-decoration: none;
      font-size: 14px;
    }
    
    .test-link:hover {
      text-decoration: underline;
    }
    
    .info-box {
      background: #e8f4fd;
      border: 1px solid #b8daff;
      border-radius: 4px;
      padding: 15px;
      margin-top: 15px;
    }
    
    .info-box h3 {
      margin-top: 0;
      color: #004085;
    }
    
    .info-box p {
      margin: 5px 0;
      color: #004085;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>🐱 MewTrack 调试工具</h1>
    <p>检查插件状态和测试功能</p>
  </div>

  <div class="section">
    <h2>插件状态</h2>
    <div class="status-item">
      <span class="status-label">插件版本:</span>
      <span class="status-value" id="version">检测中...</span>
    </div>
    <div class="status-item">
      <span class="status-label">存储状态:</span>
      <span class="status-value" id="storage-status">检测中...</span>
    </div>
    <div class="status-item">
      <span class="status-label">OpenAI API:</span>
      <span class="status-value" id="api-status">检测中...</span>
    </div>
    <div class="status-item">
      <span class="status-label">今日打卡网站数:</span>
      <span class="status-value" id="today-sites">检测中...</span>
    </div>
    <div class="status-item">
      <span class="status-label">总连续天数:</span>
      <span class="status-value" id="total-streak">检测中...</span>
    </div>
  </div>

  <div class="section">
    <h2>视频网站测试</h2>
    <p>点击以下链接测试视频检测功能（在新标签页打开）:</p>
    
    <div class="test-links">
      <strong>YouTube 测试:</strong><br>
      <a href="https://www.youtube.com/watch?v=RRKJiM9Njr8" target="_blank" class="test-link">
        📚 学习类: My Mix for Work & Study
      </a>
      <a href="https://www.youtube.com/watch?v=jfKfPfyJRdk" target="_blank" class="test-link">
        📚 学习类: lofi hip hop radio
      </a>
      <a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ" target="_blank" class="test-link">
        🎵 娱乐类: 音乐MV
      </a>
    </div>
    
    <div class="test-links">
      <strong>Bilibili 测试:</strong><br>
      <a href="https://www.bilibili.com/video/BV1GJ411x7h7" target="_blank" class="test-link">
        📚 学习类: Python教程
      </a>
      <a href="https://www.bilibili.com/video/BV1FX4y1g7u8" target="_blank" class="test-link">
        🎮 娱乐类: 游戏视频
      </a>
    </div>
    
    <div class="info-box">
      <h3>测试说明</h3>
      <p>1. 点击链接后，等待3-5秒让页面完全加载</p>
      <p>2. 如果是学习类视频，应该会弹出打卡窗口</p>
      <p>3. 如果是娱乐类视频，不会有弹窗</p>
      <p>4. 查看浏览器控制台(F12)可以看到详细的检测日志</p>
    </div>
  </div>

  <div class="section">
    <h2>功能测试</h2>
    <div class="button-group">
      <button class="btn-primary" onclick="testStorage()">测试存储</button>
      <button class="btn-primary" onclick="testSiteDetection()">测试网站检测</button>
      <button class="btn-primary" onclick="clearTodayData()">清除今日数据</button>
      <button class="btn-secondary" onclick="openSettings()">打开设置</button>
      <button class="btn-secondary" onclick="openPopup()">打开弹窗</button>
    </div>
    
    <div class="log-container" id="log"></div>
  </div>

  <div class="section">
    <h2>自定义网站</h2>
    <div id="custom-sites-list">
      加载中...
    </div>
  </div>

  <script src="js/storage.js"></script>
  <script src="js/openaiIntegration.js"></script>
  <script src="js/siteDetector.js"></script>
  
  <script>
    const logContainer = document.getElementById('log');
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : 'ℹ️';
      logContainer.textContent += `[${timestamp}] ${prefix} ${message}\n`;
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    // 初始化
    async function init() {
      try {
        // 获取manifest信息
        const manifest = chrome.runtime.getManifest();
        document.getElementById('version').textContent = manifest.version;
        document.getElementById('version').className = 'status-value status-ok';
        
        // 检查存储
        const storage = new MewTrackStorage();
        const data = await storage.getAllData();
        document.getElementById('storage-status').textContent = '正常';
        document.getElementById('storage-status').className = 'status-value status-ok';
        
        // 检查API状态
        await openAIIntegration.init();
        const apiStatus = document.getElementById('api-status');
        if (openAIIntegration.apiKey) {
          apiStatus.textContent = '已配置';
          apiStatus.className = 'status-value status-ok';
        } else {
          apiStatus.textContent = '未配置';
          apiStatus.className = 'status-value status-warning';
        }
        
        // 显示统计
        const stats = await storage.getStats();
        document.getElementById('today-sites').textContent = stats.checkedSitesToday || 0;
        document.getElementById('total-streak').textContent = stats.totalStreak || 0;
        
        // 加载自定义网站
        await loadCustomSites();
        
        log('调试工具初始化完成', 'success');
      } catch (error) {
        log('初始化失败: ' + error.message, 'error');
      }
    }

    // 加载自定义网站
    async function loadCustomSites() {
      try {
        const storage = new MewTrackStorage();
        const customSites = await storage.getCustomSites();
        const container = document.getElementById('custom-sites-list');
        
        if (Object.keys(customSites).length === 0) {
          container.innerHTML = '<p>没有自定义网站</p>';
        } else {
          const html = Object.entries(customSites).map(([domain, site]) => `
            <div class="status-item">
              <span class="status-label">${site.name}</span>
              <span class="status-value ${site.enabled ? 'status-ok' : 'status-error'}">
                ${domain} (${site.enabled ? '启用' : '禁用'})
              </span>
            </div>
          `).join('');
          container.innerHTML = html;
        }
      } catch (error) {
        document.getElementById('custom-sites-list').innerHTML = '<p class="status-error">加载失败</p>';
      }
    }

    // 测试存储
    async function testStorage() {
      log('开始测试存储功能...');
      try {
        const storage = new MewTrackStorage();
        const data = await storage.getAllData();
        log('成功读取数据，网站数: ' + Object.keys(data.sites || {}).length, 'success');
        
        // 测试写入
        const testData = { test: Date.now() };
        await chrome.storage.local.set({ mewtrack_test: testData });
        const readData = await chrome.storage.local.get('mewtrack_test');
        
        if (readData.mewtrack_test.test === testData.test) {
          log('存储读写测试成功', 'success');
        } else {
          log('存储读写测试失败', 'error');
        }
        
        // 清理测试数据
        await chrome.storage.local.remove('mewtrack_test');
      } catch (error) {
        log('存储测试失败: ' + error.message, 'error');
      }
    }

    // 测试网站检测
    async function testSiteDetection() {
      log('开始测试网站检测...');
      try {
        const currentDomain = window.location.hostname;
        const isLearning = await siteDetector.isLearningSite(currentDomain);
        log(`当前域名: ${currentDomain}`, 'info');
        log(`是否为学习网站: ${isLearning}`, isLearning ? 'success' : 'info');
        
        const siteInfo = await siteDetector.getSiteInfo(currentDomain);
        if (siteInfo) {
          log(`网站信息: ${siteInfo.name} (${siteInfo.type})`, 'info');
        }
      } catch (error) {
        log('网站检测失败: ' + error.message, 'error');
      }
    }

    // 清除今日数据
    async function clearTodayData() {
      if (confirm('确定要清除今日打卡数据吗？')) {
        try {
          const storage = new MewTrackStorage();
          const data = await storage.getAllData();
          data.globalStats.checkedSitesToday = [];
          await storage.saveAllData(data);
          log('今日数据已清除', 'success');
          await init(); // 刷新显示
        } catch (error) {
          log('清除失败: ' + error.message, 'error');
        }
      }
    }

    // 打开设置
    function openSettings() {
      chrome.runtime.openOptionsPage();
    }

    // 打开弹窗
    function openPopup() {
      window.open(chrome.runtime.getURL('popup.html'), 'MewTrack', 'width=400,height=600');
    }

    // 页面加载完成后初始化
    init();
  </script>
</body>
</html>